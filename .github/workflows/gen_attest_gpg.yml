name: Generate, Store, and Attest GPG Key
on:
  workflow_dispatch:

jobs:
  generate-and-store-gpg-key:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: Install GPG
        run: sudo apt-get update && sudo apt-get install -y gnupg

      - name: Generate GPG Key
        run: |
          cat >gen-key-script <<EOF
          %echo Generating a basic OpenPGP key
          Key-Type: RSA
          Key-Length: 2048
          Subkey-Type: RSA
          Subkey-Length: 2048
          Name-Real: GitHub Actions
          Name-Comment: Automatically generated by GitHub Actions
          Name-Email: actions@github.com
          Expire-Date: 0
          %no-protection
          %commit
          %echo Done
          EOF
          gpg --batch --generate-key gen-key-script
          gpg --armor --export actions@github.com > public.key
          gpg --armor --export-secret-keys actions@github.com > private.key
          PUBLIC_KEY=$(cat public.key | base64)
          PRIVATE_KEY=$(cat private.key | base64)
          echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_ENV
          echo "PRIVATE_KEY=$PRIVATE_KEY" >> $GITHUB_ENV
      - name: Store GPG Private Key in GitHub Secrets
        uses: hmanzur/actions-set-secret@v2.0.0
        with:
          name: 'GPG_SEC_KEY'
          value: '${{ env.GPG_PRIVATE_KEY }}'
          token: ${{ secrets.PAT }}

      - name: Output Public Key
        run: |
          echo "GPG Public Key: ${{ env.GPG_PUBLIC_KEY }}"

      - name: Create Public Key File
        run: echo "${{ env.GPG_PUBLIC_KEY }}" > public.key

      - name: Attest GPG Key Generation
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: "${{ github.workspace }}/public.key"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Display Attestation Details
        run: cat /tmp/attestation.jsonl